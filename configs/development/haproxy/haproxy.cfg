global
    stats socket /var/run/haproxy.sock mode 666 level admin

defaults
    mode http
    timeout connect 5000
    timeout client 50000
    timeout server 50000

frontend http
    bind *:80
    
    # Stick table for tracking client behavior
    stick-table type ip size 100k expire 30m store http_req_rate(10s),http_err_rate(10s),gpc0,conn_rate(10s),conn_cur
    
    # Track all requests
    tcp-request content track-sc0 src
    
    # Increment gpc0 counter for bad bot detection
    acl is_bad_bot req.hdr(User-Agent) -i BadBot
    http-request track-sc0 src,+1 if is_bad_bot
    
    # Define ACLs based on stick table entries
    acl abuse_suspect sc0_http_req_rate(http) gt 10
    acl has_errors sc0_http_err_rate(http) gt 5
    acl bot_detected sc0_gpc0 gt 0
    
    # Route traffic
    use_backend backend1 if { path_beg /backend1 }
    use_backend backend2 if { path_beg /backend2 }
    default_backend backend1

backend backend1
    balance roundrobin
    server web1 backend1:80 check

backend backend2
    balance roundrobin
    server web2 backend2:80 check

frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
